<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>AR Demo</title>
  <!-- ========== –°–¢–ò–õ–Ü ========== -->
  <style>
    body, html { margin:0; padding:0; overflow:hidden; }
    #screen-overlay {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      display:flex; flex-direction:column;
      justify-content:center; align-items:center;
      background:rgba(0,0,0,0.5); z-index:10;
    }
    #start-ar, .order-button, #model-switch-buttons button {
      margin:8px; padding:12px 24px; font-size:1em;
    }
    #search-frame {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:150px; height:150px;
      z-index:5; display:none;
    }
    .error-text {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      color:red; font-size:1.2em;
      background:rgba(255,255,255,0.8);
      padding:12px; border-radius:4px;
      z-index:20;
    }
    canvas { position:absolute; top:0; left:0; }
  </style>

  <!-- ========== IMPORTMAP –î–õ–Ø three.js ========== -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "GLTFLoader": "https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js",
      "ARButton": "https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js"
    }
  }
  </script>
  <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
</head>

<body>
  <!-- ======= –°–¢–ê–†–¢–û–í–ò–ô –û–í–ï–†–õ–ï–ô ======= -->
  <div id="screen-overlay">
    <button id="start-ar"></button>
    <div id="order-button-container"></div>
    <div id="model-switch-buttons"></div>
  </div>

  <!-- ======= –ê–Ω—ñ–º–∞—Ü—ñ—è ‚Äú–ø–æ—à—É–∫ –ø–æ–≤–µ—Ä—Ö–Ω—ñ‚Äù ======= -->
  <img id="search-frame">

  <!-- ======= AR canvas ======= -->
  <canvas id="ar-canvas"></canvas>

  <script type="module">
  import * as THREE from 'three';
  import { GLTFLoader } from 'GLTFLoader';
  import { ARButton } from 'ARButton';

  // 1) –†–û–ó–ë–Ü–† URL-–ü–ê–†–ê–ú–ï–¢–†–Ü–í
  const params          = new URLSearchParams(window.location.search);
  const lang            = params.get('lang')          || 'ua';
  const byUrl           = params.get('byUrl')         || null;
  const commodityName   = params.get('commodityName') || null;
  const scaleEnabled    = params.has('scale');
  const buttonsArCount  = parseInt(params.get('buttonsAr')) || 0;
  const modelLabel      = commodityName || null;

  // 2) UI-–∫–æ–Ω—Ñ—ñ–≥ –¥–ª—è —Ñ–æ–Ω—É —Ç–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ –∫–∞–¥—Ä—ñ–≤
  const uiConfig = {
    backgroundUrl: params.get('background') ||
      'https://raw.githubusercontent.com/Katr5na/WebGL-Surface-Tracking-AR/master/ui/background/peachy.jpg',
    helpSequenceUrl:
      'https://raw.githubusercontent.com/Katr5na/WebGL-Surface-Tracking-AR/master/ui/help_to_install_sequence'
  };

  let translations = {};
  let currentModelIndex = 0;

  // 3) –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø –õ–û–ö–ê–õ–Ü–ó–ê–¶–Ü–á
  async function loadLocalization() {
    try {
      const gs = await fetch('GoogleSheetsLocalization.json').then(r=>r.json());
      const url = new URL(gs.codeGsUrl);
      url.searchParams.set('sheetKey', gs.sheetKey);
      url.searchParams.set('sheetName', gs.sheetName);
      url.searchParams.set('lang', lang);
      translations = await fetch(url).then(r=>r.json());
    } catch(e) {
      console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ª–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—é, –±—É–¥—É—Ç—å –¥–µ—Ñ–æ–ª—Ç–∏', e);
      translations = {};
    }
  }

  // 4) –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø UI
  async function initUI() {
    await loadLocalization();

    // —Ñ–æ–Ω
    document.body.style.backgroundImage = `url(${uiConfig.backgroundUrl})`;
    document.body.style.backgroundSize  = 'cover';

    // –∫–Ω–æ–ø–∫–∞ ‚Äú–ó–∞–ø—É—Å—Ç–∏—Ç–∏ AR‚Äù
    const startBtn = document.getElementById('start-ar');
    startBtn.textContent = translations.startAr || '–ó–∞–ø—É—Å—Ç–∏—Ç–∏ AR';
    startBtn.addEventListener('click', ()=> {
      document.getElementById('screen-overlay').style.display = 'none';
      startARSession();
      startSearchAnimation();
    });

    // –∫–Ω–æ–ø–∫–∞ ‚Äú–ó–∞–º–æ–≤–∏—Ç–∏‚Äù
    if (byUrl) {
      const c = document.getElementById('order-button-container');
      const btn = document.createElement('a');
      btn.href = byUrl;
      btn.textContent = translations.byButton || '–ó–∞–º–æ–≤–∏—Ç–∏';
      btn.classList.add('order-button');
      c.append(btn);
    }

    // –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –º–æ–¥–µ–ª–µ–π
    const sw = document.getElementById('model-switch-buttons');
    for (let i=0; i<buttonsArCount; i++) {
      const btn = document.createElement('button');
      btn.textContent = 
        translations.buttonTexts?.[i] || `–ú–æ–¥–µ–ª—å ${i+1}`;
      btn.addEventListener('click', ()=> currentModelIndex = i);
      sw.append(btn);
    }
  }

  // 5) –ê–Ω—ñ–º–∞—Ü—ñ—è ‚Äú–ø–æ—à—É–∫‚Äù (75 –∫–∞–¥—Ä—ñ–≤ –∑–∞ ~2 —Å–µ–∫)
  let searchAnimationInterval;
  function startSearchAnimation() {
    const img = document.getElementById('search-frame');
    img.style.display = 'block';
    let frame = 0, total = 75, interval = 2000/75;
    searchAnimationInterval = setInterval(()=>{
      const n = String(frame).padStart(2,'0');
      img.src = `${uiConfig.helpSequenceUrl}/frame_${n}_delay-0.08s.png`;
      frame = (frame+1)%total;
    }, interval);
  }
  function stopSearchAnimation() {
    clearInterval(searchAnimationInterval);
    document.getElementById('search-frame').style.display = 'none';
  }

  // 6) AR-–õ–û–ì–Ü–ö–ê
  let scene, camera, renderer, reticle, modelObjects = [];

  async function startARSession() {
    // üîπ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –º–æ–¥–µ–ª—ñ –∑ JSON-–∫–æ–Ω—Ñ—ñ–≥—É (lion.json —á–∏ reni.json)
    const configUrl = params.get('config');
    const list = await fetch(configUrl).then(r=>r.json());
    const loader = new GLTFLoader();
    modelObjects = await Promise.all(
      list.map(e =>
        loader.loadAsync(e.url)
          .then(g=>g.scene)
          .catch(_=>null)
      )
    );

    // üîπ –°—Ç–≤–æ—Ä—é—î–º–æ —Å—Ü–µ–Ω—É, –∫–∞–º–µ—Ä—É, —Å–≤—ñ—Ç–ª–æ
    scene    = new THREE.Scene();
    camera   = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);
    scene.add(new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1));

    // üîπ –†–µ–Ω–¥–µ—Ä–µ—Ä —ñ–∑ XR
    renderer = new THREE.WebGLRenderer({
      antialias: true, alpha: true, canvas: document.getElementById('ar-canvas')
    });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.append(
      ARButton.createButton(renderer, {
        requiredFeatures: ['hit-test','dom-overlay'],
        domOverlay: { root: document.body }
      })
    );

    // üîπ –†–µ—Ç—ñ–∫–ª + –∂–æ–≤—Ç–∏–π –∫–æ–ª—ñ—Ä
    reticle = new THREE.Mesh(
      new THREE.RingGeometry(0.15,0.2,32).rotateX(-Math.PI/2),
      new THREE.MeshBasicMaterial({ color: 0xFFD700 })
    );
    reticle.matrixAutoUpdate = false;
    reticle.visible = false;
    scene.add(reticle);

    // üîπ –•—ñ—Ç-—Ç–µ—Å—Ç–∏ —Ç–∞ ‚Äúselect‚Äù
    let hitSource, localRef;
    renderer.xr.addEventListener('sessionstart', async ()=>{
      const session = renderer.xr.getSession();
      const viewer  = await session.requestReferenceSpace('viewer');
      hitSource     = await session.requestHitTestSource({ space: viewer });
      localRef      = await session.requestReferenceSpace('local');
      session.addEventListener('select', onSelect);
    });

    // üîπ –¶–∏–∫–ª —Ä–µ–Ω–¥–µ—Ä–∞
    renderer.setAnimationLoop((_, frame)=>{
      if (frame && hitSource) {
        const hits = frame.getHitTestResults(hitSource);
        if (hits.length) {
          const pose = hits[0].getPose(localRef);
          reticle.visible = true;
          reticle.matrix.fromArray(pose.transform.matrix);
          stopSearchAnimation();
        }
      }
      renderer.render(scene, camera);
    });

    window.addEventListener('resize', ()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // üîπ –ñ–µ—Å—Ç–∏ (–ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è/–ø–æ–≤–æ—Ä–æ—Ç/–º–∞—Å—à—Ç–∞–±) ‚Äî –≤—Å—Ç–∞–≤—Ç–µ —Ç—É—Ç –≤–∞—à –∫–æ–¥, –æ–±–≥–æ—Ä–Ω—É–≤—à–∏ –±–ª–æ–∫ –º–∞—Å—à—Ç–∞–±—É:
    // if (scaleEnabled && touches.length === 2) { ‚Ä¶ }
  }

  // 7) –û–±—Ä–æ–±–Ω–∏–∫ ‚Äúselect‚Äù (—Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ –∞–±–æ –ø–æ–º–∏–ª–∫–∞)
  function onSelect() {
    if (!commodityName) {
      const err = document.createElement('div');
      err.classList.add('error-text');
      err.textContent = translations.error || '–ü–æ–º–∏–ª–∫–∞ 005';
      document.body.append(err);
      return;
    }
    const mdl = modelObjects[currentModelIndex]?.clone();
    if (mdl) {
      mdl.applyMatrix4(reticle.matrix);
      scene.add(mdl);
    }
    reticle.visible = false;
    stopSearchAnimation();
  }

  // === –ó–∞–ø—É—Å–∫–∞—î–º–æ UI –Ω–∞ –ø–æ—á–∞—Ç–∫—É ===
  initUI();
  </script>
</body>
</html>
